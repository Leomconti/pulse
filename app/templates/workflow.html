{% extends "base.html" %} {% block title %}Workflow - Pulse{% endblock %} {% block content %}
<div class="px-4 py-6 sm:px-0">
  <div class="border-4 border-dashed border-gray-200 rounded-lg p-6">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        <i class="fas fa-project-diagram text-blue-600 mr-3"></i>
        Agentic Workflow
      </h1>
      <p class="text-gray-600">
        Start a natural language query workflow and watch the processing in real-time through each agent step.
      </p>
    </div>

    <!-- Input Form -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">
        <i class="fas fa-play-circle text-green-600 mr-2"></i>
        Start New Workflow
      </h2>

      <!-- Schema Source Toggle -->
      <div class="mb-6">
        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg w-fit">
          <button
            type="button"
            id="manual-tab"
            class="px-4 py-2 text-sm font-medium rounded-md transition-colors bg-white text-blue-600 shadow-sm"
            onclick="switchSchemaSource('manual')"
          >
            <i class="fas fa-code mr-2"></i>Manual Schema
          </button>
          <button
            type="button"
            id="connection-tab"
            class="px-4 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900"
            onclick="switchSchemaSource('connection')"
          >
            <i class="fas fa-database mr-2"></i>Database Connection
          </button>
        </div>
      </div>

      <!-- Manual Schema Form -->
      <form
        id="manual-form"
        class="space-y-4"
        hx-post="/api/v1/workflows/start-htmx"
        hx-trigger="submit"
        hx-target="#workflow-panel"
        hx-swap="innerHTML"
        hx-indicator="#start-loading"
      >
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"> Natural Language Query </label>
          <input
            name="query"
            type="text"
            required
            placeholder="e.g., count all active users where age > 18"
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"> Database Schema (JSON) </label>
          <textarea
            name="schema"
            rows="8"
            required
            placeholder='{"tables": {"users": {"columns": ["id", "name", "email"]}}}'
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
          >
{{ default_schema | safe }}</textarea
          >
        </div>

        <div class="flex items-center space-x-4">
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          >
            <i class="fas fa-rocket mr-2"></i>
            Run Workflow
          </button>

          <div id="start-loading" class="htmx-indicator flex items-center text-blue-600">
            <i class="fas fa-spinner fa-spin mr-2"></i>
            Starting workflow...
          </div>
        </div>
      </form>

      <!-- Connection-based Schema Form -->
      <form
        id="connection-form"
        class="space-y-4 hidden"
        hx-post="/api/v1/workflows/start-with-connection"
        hx-trigger="submit"
        hx-target="#workflow-panel"
        hx-swap="innerHTML"
        hx-indicator="#start-loading-connection"
      >
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"> Natural Language Query </label>
          <input
            name="query"
            type="text"
            required
            placeholder="e.g., count all active users where age > 18"
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"> Database Connection </label>
          <select
            name="connection_id"
            id="connection-select"
            required
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">Select a database connection...</option>
          </select>
          <div class="mt-2 flex items-center space-x-2">
            <button
              type="button"
              id="refresh-connections"
              class="text-sm text-blue-600 hover:text-blue-800 underline"
              onclick="loadDatabaseConnections()"
            >
              <i class="fas fa-refresh mr-1"></i>Refresh Connections
            </button>
            <button
              type="button"
              id="preview-schema"
              class="text-sm text-green-600 hover:text-green-800 underline"
              onclick="previewSchema()"
              disabled
            >
              <i class="fas fa-eye mr-1"></i>Preview Schema
            </button>
          </div>
        </div>

        <!-- Schema Preview -->
        <div id="schema-preview" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2"> Schema Preview </label>
          <div class="bg-gray-50 border border-gray-200 rounded-md p-4 max-h-48 overflow-y-auto">
            <pre id="schema-content" class="text-xs text-gray-700"></pre>
          </div>
        </div>

        <div class="flex items-center space-x-4">
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          >
            <i class="fas fa-rocket mr-2"></i>
            Run Workflow
          </button>

          <div id="start-loading-connection" class="htmx-indicator flex items-center text-blue-600">
            <i class="fas fa-spinner fa-spin mr-2"></i>
            Starting workflow...
          </div>
        </div>
      </form>
    </div>

    <!-- Workflow Panel -->
    <div id="workflow-panel" class="min-h-96">
      <!-- Workflow results will be displayed here -->
      <div class="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
        <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
        <p class="text-gray-500 text-lg">No workflow running</p>
        <p class="text-gray-400 text-sm">Submit a query above to start the workflow</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Schema source management
  function switchSchemaSource(source) {
    const manualTab = document.getElementById("manual-tab");
    const connectionTab = document.getElementById("connection-tab");
    const manualForm = document.getElementById("manual-form");
    const connectionForm = document.getElementById("connection-form");

    if (source === "manual") {
      // Update tab styling
      manualTab.className =
        "px-4 py-2 text-sm font-medium rounded-md transition-colors bg-white text-blue-600 shadow-sm";
      connectionTab.className =
        "px-4 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900";

      // Show/hide forms
      manualForm.classList.remove("hidden");
      connectionForm.classList.add("hidden");
    } else if (source === "connection") {
      // Update tab styling
      connectionTab.className =
        "px-4 py-2 text-sm font-medium rounded-md transition-colors bg-white text-blue-600 shadow-sm";
      manualTab.className =
        "px-4 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900";

      // Show/hide forms
      connectionForm.classList.remove("hidden");
      manualForm.classList.add("hidden");

      // Load connections when switching to connection mode
      loadDatabaseConnections();
    }
  }

  // Load available database connections
  async function loadDatabaseConnections() {
    try {
      const response = await fetch("/api/v1/instances");
      const connections = await response.json();

      const select = document.getElementById("connection-select");
      // Clear existing options except the first one
      select.innerHTML = '<option value="">Select a database connection...</option>';

      connections.forEach((connection) => {
        const option = document.createElement("option");
        option.value = connection.id;
        option.textContent = `${connection.name} (${connection.db_type})`;
        select.appendChild(option);
      });

      // Enable schema preview button when connection is selected
      select.addEventListener("change", function () {
        const previewBtn = document.getElementById("preview-schema");
        previewBtn.disabled = !this.value;
      });
    } catch (error) {
      console.error("Failed to load database connections:", error);
      alert("Failed to load database connections. Please try again.");
    }
  }

  // Preview schema for selected connection
  async function previewSchema() {
    const connectionId = document.getElementById("connection-select").value;
    if (!connectionId) return;

    try {
      const response = await fetch(`/api/v1/instances/${connectionId}/schema`);
      const data = await response.json();

      if (data.status === "ok") {
        document.getElementById("schema-content").textContent = JSON.stringify(data.schema, null, 2);
        document.getElementById("schema-preview").classList.remove("hidden");
      } else {
        alert("Failed to get schema: " + (data.message || "Unknown error"));
      }
    } catch (error) {
      console.error("Failed to preview schema:", error);
      alert("Failed to preview schema. Please try again.");
    }
  }

  // Set default schema for demo purposes
  document.addEventListener("DOMContentLoaded", function () {
    const defaultSchema = {
      tables: {
        users: {
          columns: ["id", "name", "email", "age", "status", "created_at"],
          types: {
            id: "int",
            name: "varchar",
            email: "varchar",
            age: "int",
            status: "varchar",
            created_at: "timestamp",
          },
        },
        orders: {
          columns: ["id", "user_id", "product_id", "quantity", "price", "created_at"],
          types: {
            id: "int",
            user_id: "int",
            product_id: "int",
            quantity: "int",
            price: "decimal",
            created_at: "timestamp",
          },
        },
        products: {
          columns: ["id", "name", "price", "category", "created_at"],
          types: {
            id: "int",
            name: "varchar",
            price: "decimal",
            category: "varchar",
            created_at: "timestamp",
          },
        },
      },
    };

    const schemaTextarea = document.querySelector('textarea[name="schema"]');
    if (schemaTextarea && !schemaTextarea.value.trim()) {
      schemaTextarea.value = JSON.stringify(defaultSchema, null, 2);
    }
  });
</script>
{% endblock %}
